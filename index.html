<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>enrollment_rate</title>
    <!-- <script type="text/javascript" src="scripts/jquery-1.7.2.min.js"></script> -->
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <!-- <link rel="stylesheet" type="text/css" href="style.css"> -->
</head>
<style>

/*button{
  margin-left: 15px;
}
.option{
  margin: 30px;
}*/
html, body {
    height: 100%;
}
#title{
    /*margin: 0px auto;*/
    width :1000 ;
    height : 580;
    font-weight: normal;
    text-align: left;
}
h1{
    font-size: 20px;
    font-weight: inherit;
    text-align: inherit;
  /*align: center;*/
}
h2{
    font-weight: inherit;
    text-align: inherit;
}
.column{
  display: inline-block;
  vertical-align: top;
}
body{
    height: 100%;
    display: table-cell;
    vertical-align: middle;
    /*text-align: center;*/
    font-size: 16px;
    font-family: 'cwTeXYen', sans-serif;
    letter-spacing: 1px;
    line-height: 20px;
    font-weight: normal;
    color: #666666  #ea5a5a;
}

#checkboxes{
    font-size:16px;
    position: absolute;
    left: 1000px;
}

</style>
<body>
    <div class="title" sytle="margin: 0px auto">
        <h1 align="center">您想知道你心目中校系的註冊率和該學類其他科系相比是多還是少嗎？</h1>
        <h2 align="center">馬上點選下列選單點選該學類確認看看吧！</h2>
    </div>
    <div class="option">
    <span style="font-size:16px">選擇領域：</span>
    <select id="field" ></select>
    <!-- onChange="renew(this.selectedIndex);" -->
<!--         <option disabled=disabled selected=selected>領域
        <option>教育領域</option>
        <option>人文及藝術領域</option>
        <option>社會科學、商業及法律領域</option>
        <option>科學領域</option>
        <option>工程、製造及營造領域</option>
        <option>農學領域</option>
        <option>醫藥衛生及社福領域</option>
        <option>服務領域</option>
        <option>其他領域</option> -->

    <span style="font-size:16px">選擇學門：</span>
    <select id="discipline">
<!--         <option value="0" disabled=disabled selected=selected>請先選取領域</option>
 -->    </select>
    <span style="font-size:16px">選擇學類：</span>
    <select id="subject"></select>
    <button id="search" type="button">search</button>
     <span style="text-anchor:left"><br>(顏色分類以教育部公佈之科系代碼為準)<br>
    參考來源：教育部104年公佈之大專院校註冊率<br>
    </span>
    </div>
    <div class="row">
        <div class="column">
            <div class="chart"></div>
        </div>
        <div class="column">
            <div id="checkboxes"></div>
        </div>
    </div>
    <!-- <div id="tooltip" class="hidden"></div> -->
    <!-- <div id = "legendContainer" class="legendContainer"></div> -->
<script>

        // discipline_option=new Array();
        // discipline_option[1]=["教育學門"];
        // discipline_option[2]=["藝術學門", "人文學門", "設計學門"];
        // discipline_option[3]=["社會及行為科學學門", "傳播學門", "商業及管理學門", "法律學門"];
        // discipline_option[4]=["生命科學學門", "自然科學學門", "數學及統計學門", ,"電算機學門"];
        // discipline_option[5]=["工程學門", "建築及都市規劃學門"];
        // discipline_option[6]=["農業科學學門", "獸醫學門"];
        // discipline_option[7]=["醫藥衛生學門", "社會服務學門"];
        // discipline_option[8]=["民生學門", "運輸服務學門", "環境保護學門", "軍營國防安全學門"];
        // discipline_option[9]=["其他學門"];




    $(document).ready(function()
    {
        Page_Init();

    });

    var subjectNumber;

    function Page_Init()
    {
        $.getJSON("data/field.json", function (data){
            $('#field').empty()
                        .append($('<option></option>').val('').text("請選擇領域"));
            $.each(data, function (i, item){
                $('#field').append(
                            $('<option></option>').val(item.fieldId)
                                                .text(item.fieldName)
                            );
            });
        });

        $('#discipline').empty().append($('<option></option>').val('').text("-"));
        $('#subject').empty().append($('<option></option>').val('').text("-"));

        //if there is a change, change it!
        $('#field').change(function(){
            fieldChange();
        });

        $('#discipline').change(function(){
            disciplineChange();
        });
        //get the subjectNumber
        $('#subject').change(function(){
            subjectNumber = $.trim($('#subject option:selected').val());
        });
    }

    function fieldChange(){

        $('#discipline').empty().append($('<option></option>').val('').text("請選擇學門"));
        $('#subject').empty().append($('<option></option>').val('').text("-"));

        var fieldNumber = $.trim($('#field option:selected').val());
        if(fieldNumber.length != 0){
            $.getJSON('data/discipline_0'+ fieldNumber +'.json', function(data){
                $.each(data, function(i, item){
                    $('#discipline').append(
                                    $('<option></option>').val(item.disciplineId)
                                                        .text(item.disciplineName)
                                        );
                });
            });
        }
    }

    function disciplineChange(){

        $('#subject').empty().append($('<option></option>').val('').text("請選擇學類"));

        var fieldNumber = $.trim($('#field option:selected').val());
        var disciplineNumber = $.trim($('#discipline option:selected').val());

        console.log('data/subject_0'+ fieldNumber + disciplineNumber + '.json')
        if(fieldNumber.length != 0  && disciplineNumber.length!=0){
            $.getJSON('data/subject_0'+ fieldNumber + disciplineNumber + '.json', function(data){
                $.each(data, function(i, item){
                    $('#subject').append(
                                $('<option></option>').val(item.subjectId)
                                                    .text(item.subjectName)
                                        );
                });
            });
        }
    };
    //used to filter JSON and choose what to display
    //it will return values whose id is selected key in json
    function filterJSON(json, key, value) {
        var result = [];
            for (var foo in json) {
                if (json[foo][key] === value) {
                    result.push(json[foo]);
                }
            }
        return result;
    }
//create json along with json
document.getElementById("search").onclick = function () {
d3.selectAll("#selectSubject").remove();
// d3.selectAll(".xAxis").remove();
var selectDepartment;
d3.json("data/checkboxList_" + subjectNumber + ".json" , function(error, json){
if (error)
{
    console.log(error);
}
    var margin = {top: 10, right: 0, bottom: 140, left: 0};
    var width = 1000 , height = 450, padding = 30, barMargin = 5;
    $.each(json, function () {
        $("#checkboxes").attr({
                            "width": width
                        })
                        .append($("<div>").text(this.Name)
                        .attr('style', "color:" + this.Color)
                        .attr('id', "selectSubject")
                        .prepend(
                            $("<input>").attr('type', 'checkbox')
                                    .val(this.Id)
                                    .prop('checked', this.checked)
                        )//add tip color!
                        .append($("<span>")
                        .text("█")
                        .attr({
                            "background-color": this.Color,
                            // "fill": this.Color
                        })));
        selectDepartment = filterJSON(json, "checked", true);
    });


    $("#checkboxes").on('change', '[type=checkbox]', function () {
        if(!this.checked){
            for (var foo in json) {
                if (json[foo]["Id"] === this.value) {
                    json[foo]["checked"] = false;
                }
            }
        }
        else{
            for (var foo in json) {
                if (json[foo]["Id"] === this.value) {
                    json[foo]["checked"] = true;
                }
            }
        }
        selectDepartment = filterJSON(json, "checked", true);
        // console.log(json);
        console.log("12354");
        console.log(selectDepartment);
    });
// d3 to visualize
    d3.select("svg").remove();
    console.log(subjectNumber);
    console.log("data/" + subjectNumber +  ".csv");
d3.csv("data/" + subjectNumber +  ".csv", function(error, data){
if (error){
    console.log(error);
}
    //let it do not look so big
    if(data.length === 1 ){
        width = 1000/4;
    }
    console.log(data);
    $("#checkboxes").on('change', '[type=checkbox]', function () {
        var newData = updataData(data,selectDepartment);
        d3.selectAll("text").remove();
        d3.selectAll(".xaxis").remove()
        console.log(selectDepartment);
        console.log(data);
        updataBarChart(newData,data);
    });

    var yMax = d3.max(data, function(d){return parseInt(d.enroll_rate);}),
        yMin = d3.min(data, function(d){return parseInt(d.enroll_rate);});
    var nameLengthMax = d3.max(data, function(d){
        return d.name.length;
    });
    var xScale = d3.scale.linear()
                    .domain([0, data.length])
                    .range([padding, width - margin.left - margin.right - padding]);
    //to handle the problem that having only one data
    var yScale = data.length == 1 ?
                    d3.scale.linear()
                        .domain([0, yMax])
                        .range([padding, height - margin.top - margin.bottom - padding]):
                    d3.scale.linear()
                        .domain([yMin, yMax])
                        .range([padding, height - margin.top - margin.bottom - padding]);

    var barWidth = (width - padding * 2) / data.length - barMargin;


    data = data.sort(function(a, b) {
        return d3.descending(parseFloat(a.enroll_rate), parseFloat(b.enroll_rate));
    });


    var svg = d3.select(".chart").append("svg")
                                .attr("width", width)
                                .attr("height", height);
console.log(schoolName);
//bar chart
    var bar = svg.selectAll("rect")
                .data(data)
                .enter()
                .append("rect");

        bar.attr({
            "fill": function(d){
                for(var foo in json){
                    if(d.department_number === json[foo]["Id"]){
                        return json[foo]["Color"];
                    }
                }
                return "#000000";
            },
            "x": function(d, i){
                return xScale(i);
            },
            "y": height - margin.top - margin.bottom,
            "width": barWidth,
            "height": 0,
            "opacity": 0.5,
            "id": function(d){
                return "id" + d.department_number;
            }
            })
        .on("click", function(){
            var setNumber = d3.select(this).property("id");
            var setOpa = d3.select(this).attr("opacity");
            console.log(setNumber);
            console.log(setOpa);
            if(d3.select(this).attr("opacity") == 0.5){
                d3.selectAll("#" + setNumber).attr("opacity", 1);
            }else if(d3.select(this).attr("opacity") == 1){
                d3.selectAll("#" + setNumber).attr("opacity", 0.5);
            }
        })
        .transition()
        .duration(1000)
        .attr({
            "y": function(d){
                return height - margin.top - margin.bottom - yScale(d.enroll_rate);
            },
            "height": function(d){
                return yScale(d.enroll_rate);
            }
        });

var barTooltip = bar.append("title")
                .text(function(d) {
                    if(d.national != "公立"){
                        return d.national + d.name + " " + d.department_name;
                    }
                    return d.name + " " + d.department_name;
                });
        //TEXT and test

    svg.selectAll("text")
        .data(data)
        .enter()
        .append("text")
        .text(function(d){
            return d.enroll_rate + "%" ;
        })
        .attr({
            "x": function(d,i){
                return xScale(i);
            },
            "y": height - margin.top - margin.bottom,
            "fill": "black",
            "text-anchor": "center",
            "font-size": "12px",
            "font-weight": "bold",
            // "text-align": "right"
        })
        .transition()
        .duration(1000)
        .attr({
            "y": function(d){
                return height - margin.top - margin.bottom - yScale(d.enroll_rate)  - 5;
            }
        });
//x axis
    var schoolName = updataSchoolName(data);
    var xAxisTick = d3.svg.axis()
                .scale(xScale)
                .tickFormat(function(d,i) { return schoolName[i]; })
                .tickSize(0)
                .ticks(data.length)
                .orient("bottom");

    svg.append("g")
        .attr({
            "class": "xaxis",
            "transform": "translate(" + (barWidth/2) + "," + (height - margin.top - margin.bottom) + ")"
        })
        .call(xAxisTick)
        .selectAll("text")
        .style({
            "font-size": "13px",
            "text-anchor": "start",
            "letter-spacing": "0px",
            "font-weight": "bold",
        })
        .attr("writing-mode", "vertical-lr");
function updataData(data,indicator){
    var result=[];
    for (var foo in data){
        data[foo]["selected"] = 0;
    }
    for (var foo in data) {
        for(var barr in indicator){
            if(data[foo]["department_number"] === indicator[barr]["Id"]){
                result.push(data[foo]);
                data[foo]["selected"] = 1;
            }
        }
    }

    return result;
}

function updataBarChart(newData,data){
    //bar chart
    var count = 0;
    bar.transition()
        .duration(1000)
        .attr({
            "x": function(d, i){
                if(d.selected == 1){
                    return xScale(count++);
                }
                return xScale(data.length);
            },
            "y": function(d){
                return height - margin.top - margin.bottom - yScale(d.enroll_rate);
            },
            "width": barWidth,
            "height": function(d){
                return yScale(d.enroll_rate);
            },
            "opacity": function(d){
                if(d.selected == 1){
                    if(d3.select(this).attr("opacity") == 0.5){
                        return 0.5;
                    }else{
                        return 1;
                    }
                }
                return 0;
            }
        })

    bar.append("title")
        .text(function(d) {
            if(d.selected == 1){
                if(d.national != "公立"){
                    return d.national + d.name + " " + d.department_name;
                }
                return d.name + " " + d.department_name;
            }
        });
        //TEXT and test

    svg.selectAll("text")
        .data(newData)
        .enter()
        .append("text")
        .text(function(d, i){
            return d.enroll_rate + "%";
        })
        .transition()
        .duration(1000)
        .attr({
            "x": function(d,i){
                return xScale(i);
            },
            "y": function(d){
                return height - margin.top - margin.bottom - yScale(d.enroll_rate) - 5;
            },
            "fill": "black",
            "text-anchor": "center",
            // "text-align": "center",
            "font-weight": "bold",
            "font-size": "12px",
        });
    //x axis
        schoolName = updataSchoolName(newData);
console.log(schoolName);
console.log(newData);
count = 0;
// xScalePrint = d3.scale.linear()
//                         .domain([0, newData.length])
//                         .range([0,width - margin.left - margin.right]);
    // var xScale = d3.scale.linear()
    //                 .domain([0, data.length])
    //                 .range([padding, width - margin.left - margin.right - padding]);
    console.log(schoolName.length);
    xAxisTickNew = d3.svg.axis()
                    .scale(xScale)
                    .tickFormat(function(d,i) {
                        if(i <= schoolName.length){
                            return schoolName[i];
                        }else{
                            return "";
                        }
                    })
                    .tickSize(0)
                    .ticks(data.length)
                    .orient("bottom");
    console.log(xAxisTickNew)
      svg.append("g")
            .attr({
                "class": "xaxis",
                "transform": "translate(" + (barWidth/2) + "," + (height - margin.top - margin.bottom) + ")"
            })
            .call(xAxisTickNew)
            .selectAll("text")
            .style({
                "font-size": "13px",
                "text-anchor": "start",
                "letter-spacing": "0px",
                "font-weight": "bold",
            })
            .attr("writing-mode", "vertical-lr");
}
function updataSchoolName(data){
    var temp=[];
    for(var foo in data){
        temp.push(data[foo].name);
    }
    return temp;
}
     // var x = d3.scale.ordinal()
     //  .domain(r)
     //  .rangeRoundBands([0, width], 0.12);
// var xLable = d3.select(".xAxis").append("row");
//     xLable.data(data)
//         .enter()
//         .append("column")
//         .attr({
//             "x": function(d,i){
//                 return xScale(i) + barWidth;
//             },
//             // "transform": "rotate(90)"
//         })
//         .append("text")
//         .text(function(d, i){
//             return d.name;
//         })
//         .attr({
//             "fill": "black",
//             "font-weight": "bold",
//             "font-anchor": "center",
//             "font-size": "12px",
//             //             "-webkit-writing-mode": "vertical-lr",
//             // "writing-mode": "vertical-lr"
//          })
//         .append("br");
});
});
};


</script>
</html>